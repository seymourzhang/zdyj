<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="ReportMapper" >
  <cache type="org.mybatis.caches.ehcache.LoggingEhcache" />

    <select id="temProfileDaily" resultType="pd" useCache="false">
       SELECT  farm_id, 
		       house_id, 
		       date, 
		       right(time,2) as time, 
		       batch_no, 
		       ROUND(inside_temp1,1) inside_temp1,
               ROUND(inside_temp2,1) inside_temp2,
               ROUND(inside_temp3,1) inside_temp3,
               ROUND(inside_temp4,1) inside_temp4,
		       ROUND(inside_avg_temp,1) inside_avg_temp, 
		       ROUND(inside_set_temp,1) inside_set_temp, 
		       ROUND(high_alarm_temp,1) high_alarm_temp, 
		       ROUND(low_alarm_temp,1) low_alarm_temp, 
		       ROUND(outside_temp,1) outside_temp
	   FROM     rpt_monitor_daily
	   where 1=1
 		<if test="farmId != null and farmId !=''"> 
         and farm_id = #{farmId} 
        </if> 
        <if test="houseId != null and houseId !=''"> 
         and house_id = #{houseId} 
        </if> 
         <if test="batchId != null and batchId !=''"> 
         and batch_no = #{batchId} 
        </if>
        <if test="beginTime != null and endTime != null">
			AND (`date` BETWEEN #{beginTime} AND #{endTime} ) 
		</if> 
		order by date
    </select>
     <select id="temProfileMonth" resultType="pd" useCache="false">
       SELECT  farm_id, 
		       house_id, 
		       year,
		       month,
		       date, 
		       batch_no, 
		       ROUND(inside_temp1,1) inside_temp1,
               ROUND(inside_temp2,1) inside_temp2,
               ROUND(inside_temp3,1) inside_temp3,
               ROUND(inside_temp4,1) inside_temp4,
		       ROUND(inside_avg_temp,1) inside_avg_temp, 
		       ROUND(inside_set_temp,1) inside_set_temp, 
		       ROUND(high_alarm_temp,1) high_alarm_temp, 
		       ROUND(low_alarm_temp,1) low_alarm_temp, 
		       ROUND(outside_temp,1) outside_temp
	   FROM    rpt_monitor_month
	   where 1=1
 		<if test="farmId != null and farmId !=''"> 
         and farm_id = #{farmId} 
        </if> 
        <if test="houseId != null and houseId !=''"> 
         and house_id = #{houseId} 
        </if> 
         <if test="batchId != null and batchId !=''"> 
         and batch_no = #{batchId} 
        </if>
        <if test="beginTime != null and endTime != null">
			AND (`date` BETWEEN #{beginTime} AND #{endTime} )
		</if> 
		
		order by date
    </select>

	<select id="selectTemForMobileDay" parameterType="pd" resultType="pd" useCache="false">
			/*温度曲线：在日龄情况下；*/
			SELECT
			  (CASE WHEN a.growth_date > curdate()
				THEN 'N'
			   ELSE 'Y' END)                                               AS dataflag,
			  a.age                                                        AS data_age,
			  a.growth_date                                                AS data_date,
			  concat(date_format(a.growth_date, '%m-%d'), '(', a.age, ')') AS x_axis,
			  tData2.avgtempLeft1,
			  tData2.avgtempLeft2,
			  tData2.avgtempMiddle1,
			  tData2.avgtempMiddle2,
			  tData2.avgtempRight1,
			  tData2.avgtempRight2,
			  tData2.avgoutsidetemp,
			  tData2.highAlarmTemp,
			  tData2.lowAlarmTemp,
			  tData2.insideSetTemp
			FROM s_b_breed_detail a
			  LEFT JOIN s_b_batch_curr sbbc ON sbbc.batch_id = a.batch_id
			  LEFT JOIN (SELECT
						   tData.timeId,
						   truncate(avg(tData.inside_temp1), 1)    AS avgtempLeft1,
						   truncate(avg(tData.inside_temp2), 1)    AS avgtempLeft2,
						   round(avg(tData.inside_temp3), 1)       AS avgtempMiddle1,
						   truncate(avg(tData.inside_temp4), 1)    AS avgtempMiddle2,
						   truncate(avg(tData.inside_temp5), 1)    AS avgtempRight1,
						   truncate(avg(tData.inside_temp6), 1)    AS avgtempRight2,
						   truncate(AVG(tData.outside_temp), 1)    AS avgoutsidetemp,
						   truncate(AVG(tData.high_alarm_temp), 1) AS highAlarmTemp,
						   truncate(AVG(tData.low_alarm_temp), 1)  AS lowAlarmTemp,
						   truncate(AVG(tData.inside_set_temp), 1) AS insideSetTemp
						 FROM (SELECT
								 date_format(collect_datetime, '%Y-%m-%d') AS timeId,
								 a.*
							   FROM s_b_monitor_hist a
							   WHERE 1 = 1
									 AND a.house_id = 5
									 AND exists(SELECT 1
												FROM s_b_batch_curr sbb
												WHERE sbb.batch_id = #{BreedBatchId}
													  AND sbb.house_code = a.house_id
													  AND a.collect_datetime BETWEEN date_sub(curdate(), INTERVAL 60 DAY) AND curdate()
									 )
							  ) tData
						 GROUP BY tData.timeId
						 ORDER BY tData.timeId
						) AS tData2 ON tData2.timeId = date_format(a.growth_date, '%Y-%m-%d')
			WHERE 1 = 1
				  AND a.growth_date BETWEEN date_sub(curdate(), INTERVAL 60 DAY) AND curdate()
				  AND a.batch_id = #{BreedBatchId}
				  AND a.house_code = ${HouseId};
	</select>

	<select id="selectTemForMobileHour" parameterType="pd" resultType="pd" useCache="false">
		/*在小时情况下*/
		SELECT
		  (CASE WHEN concat(tData3.data_date, ' ', sc.biz_code) > date_format(adddate(now(), INTERVAL 30 MINUTE), '%Y-%m-%d %H:%i')
			THEN 'N'
		   ELSE 'Y' END)          				  AS dataflag,
		  sc.biz_code             				  AS x_axis,
		  5                       				  AS house_id,
		  tData3.data_date        				  AS data_date,
		  concat('(日龄：', tData2.date_age, ')') AS data_age,
		  tData2.avgtempLeft1,
		  tData2.avgtempLeft2,
		  tData2.avgtempMiddle1,
		  tData2.avgtempMiddle2,
		  tData2.avgtempRight1,
		  tData2.avgtempRight2,
		  tData2.avgoutsidetemp,
		  tData2.highAlarmTemp,
		  tData2.lowAlarmTemp,
		  tData2.insideSetTemp
		FROM s_d_code sc
		  LEFT JOIN (
					  SELECT
						CASE WHEN tData.timeId = '00:00'
						  THEN '24:00'
						ELSE tData.timeId END                   AS timeId,
						tData.house_id,
						tData.date_age,
						TRUNCATE(AVG(tData.inside_temp1), 1)    AS avgtempLeft1,
						TRUNCATE(AVG(tData.inside_temp2), 1)    AS avgtempLeft2,
						TRUNCATE(AVG(tData.inside_temp3), 1)    AS avgtempMiddle1,
						TRUNCATE(AVG(tData.inside_temp4), 1)    AS avgtempMiddle2,
						TRUNCATE(AVG(tData.inside_temp5), 1)    AS avgtempRight1,
						TRUNCATE(AVG(tData.inside_temp6), 1)    AS avgtempRight2,
						TRUNCATE(AVG(tData.outside_temp), 1)    AS avgoutsidetemp,
						TRUNCATE(AVG(tData.high_alarm_temp), 1) AS highAlarmTemp,
						TRUNCATE(AVG(tData.low_alarm_temp), 1)  AS lowAlarmTemp,
						TRUNCATE(AVG(tData.inside_set_temp), 1) AS insideSetTemp
					  FROM (SELECT
							  (CASE WHEN DATE_FORMAT(collect_datetime, '%i') BETWEEN '00' AND '30'
								THEN CONCAT(DATE_FORMAT(collect_datetime, '%H'), ':30')
							   ELSE CONCAT(DATE_FORMAT(adddate(collect_datetime, INTERVAL 1 HOUR), '%H'), ':00') END) AS timeId,
							  a.*
							FROM s_b_monitor_hist a
							WHERE a.house_id = ${HouseId}
								  AND DATE_FORMAT(a.collect_datetime, '%Y-%m-%d') = #{DataRange}
						   ) tData
					  GROUP BY tData.timeId
					  ORDER BY tData.timeId
					) AS tData2 ON tData2.timeId = sc.biz_code
		  LEFT JOIN (SELECT #{DataRange} AS data_date) AS tData3 ON 1 = 1
		WHERE sc.code_type = 'HalfHour';
	</select>
    
</mapper>